# API интеграции в проекте Sammaryhelper

## Обзор интеграций

Проект Sammaryhelper интегрируется с несколькими внешними API для обеспечения своей функциональности. Основные интеграции включают Telegram API и OpenAI API.

## 1. Telegram API

### Общая информация
- **Назначение**: Получение данных из Telegram (диалоги, сообщения, пользователи)
- **Библиотека**: Telethon
- **Документация**: [Telethon Documentation](https://docs.telethon.dev/)
- **Тип аутентификации**: API ID и API Hash + авторизация пользователя

### Ключевые компоненты интеграции

#### TelegramClientBase
- Базовый класс для работы с Telegram API
- Инициализация клиента и управление подключением
- Обработка аутентификации и сессий

```python
class TelegramClientBase:
    def __init__(self, config):
        self.config = config
        self.client = None
        # ...
        
    async def init_client(self):
        # Инициализация клиента Telegram
        self.client = TelegramClient(
            session_name,
            config.api_id,
            config.api_hash,
            # ...
        )
        # ...
```

#### TelegramClientDialogs
- Работа с диалогами (чаты, группы, каналы)
- Получение и фильтрация списка диалогов
- Кеширование диалогов в базе данных

#### TelegramClientMessages
- Работа с сообщениями
- Получение и фильтрация сообщений
- Поиск сообщений по различным критериям
- Работа с темами в супергруппах

### Особенности интеграции

1. **Асинхронное взаимодействие**:
   - Все запросы к Telegram API выполняются асинхронно
   - Используется asyncio для неблокирующих операций

2. **Кеширование данных**:
   - Диалоги, сообщения и темы кешируются в базе данных
   - Реализована проверка актуальности кеша

3. **Обработка ограничений API**:
   - Учет лимитов запросов (rate limits)
   - Обработка ошибок и повторные попытки

4. **Поддержка прокси**:
   - Возможность использования прокси для подключения к Telegram API
   - Поддержка различных типов прокси (SOCKS5, HTTP, HTTPS)

5. **Настройка клиента**:
   - Возможность настройки параметров клиента (system_version, device_model, app_version)
   - Поддержка различных устройств и версий

### Примеры использования

```python
# Получение списка диалогов
dialogs = await client_manager.filter_dialogs({
    'search': search_query,
    'limit': limit,
    'sort': sort_by
})

# Получение сообщений из диалога
messages = await client_manager.filter_messages(dialog_id, {
    'search': search_query,
    'limit': limit,
    'filter': media_filter,
    'topic_id': topic_id
})

# Поиск по нескольким чатам
results = await client_manager.search_messages_multi_chat(dialog_ids, search_params)
```

## 2. OpenAI API

### Общая информация
- **Назначение**: Генерация суммаризаций и анализ сообщений
- **Библиотека**: openai
- **Документация**: [OpenAI API Documentation](https://platform.openai.com/docs/api-reference)
- **Тип аутентификации**: API ключ

### Ключевые компоненты интеграции

#### AIChatManager
- Класс для взаимодействия с OpenAI API
- Обработка запросов и ответов
- Управление настройками моделей

```python
class AIChatManager:
    def __init__(self, settings):
        self.settings = settings
        self.openai_client = None
        
    async def get_response(self, user_query, context=""):
        # Инициализация клиента OpenAI при необходимости
        if self.openai_client is None:
            self.openai_client = openai.AsyncOpenAI(api_key=self.settings.get('openai_api_key'))
        
        # Получение ответа от модели
        response = await self.openai_client.chat.completions.create(
            model=self.settings.get('openai_model', 'gpt-3.5-turbo'),
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"Контекст сообщений:\n{context}\n\nЗапрос: {user_query}"}
            ]
        )
        # ...
```

### Функциональность

1. **Генерация суммаризаций**:
   - Создание кратких содержаний диалогов
   - Обработка больших объемов текста с разбиением на части
   - Объединение суммаризаций частей в единое содержание

2. **Анализ участников чата**:
   - Выделение ключевых участников
   - Анализ активности и ролей

3. **Ответы на вопросы пользователя**:
   - Обработка запросов пользователя о содержании диалогов
   - Использование контекста сообщений для формирования ответов

### Особенности интеграции

1. **Асинхронное взаимодействие**:
   - Асинхронные запросы к OpenAI API
   - Неблокирующая обработка ответов

2. **Управление токенами**:
   - Оценка количества токенов в запросах
   - Разбиение больших текстов на части для соблюдения лимитов

3. **Настройка моделей**:
   - Выбор модели через интерфейс (gpt-3.5-turbo, gpt-4, gpt-4-turbo-preview)
   - Настройка системного промпта

4. **Кеширование запросов**:
   - Сохранение запросов и ответов в базе данных
   - Повторное использование результатов для одинаковых запросов

### Примеры использования

```python
# Получение ответа на запрос пользователя
response = await ai_manager.get_response(
    user_query="Какие основные темы обсуждались в этом чате?",
    context=context_messages
)

# Генерация суммаризации сообщений
summary = await ai_manager.generate_summary(messages, openai_client)

# Анализ участников чата
analysis = await ai_manager.analyze_participants(participants, openai_client)
```

## 3. PostgreSQL (через asyncpg)

### Общая информация
- **Назначение**: Хранение и кеширование данных
- **Библиотека**: asyncpg
- **Документация**: [asyncpg Documentation](https://magicstack.github.io/asyncpg/current/)
- **Тип подключения**: Асинхронное подключение к базе данных

### Ключевые компоненты интеграции

#### DatabaseHandler
- Класс для работы с базой данных PostgreSQL
- Управление подключением и транзакциями
- Кеширование и получение данных

```python
class DatabaseHandler:
    def __init__(self, config_name: str = None, app_dir: str = None, debug: bool = False):
        self.connection_pool = None
        # ...
        
    async def init_connection(self) -> bool:
        # Инициализация подключения к базе данных
        self.connection_pool = await asyncpg.create_pool(
            host=self.config.get("host"),
            port=self.config.get("port"),
            database=self.config.get("database"),
            user=self.config.get("user"),
            password=self.config.get("password")
        )
        # ...
```

### Функциональность

1. **Кеширование данных**:
   - Сохранение диалогов, сообщений и тем
   - Обновление существующих данных

2. **Получение кешированных данных**:
   - Получение диалогов и сообщений из кеша
   - Фильтрация данных на уровне базы данных

3. **Управление схемой базы данных**:
   - Создание и обновление таблиц
   - Миграция данных при изменении схемы

### Особенности интеграции

1. **Асинхронное взаимодействие**:
   - Асинхронные запросы к базе данных
   - Использование пула соединений

2. **Транзакции**:
   - Обеспечение атомарности операций
   - Обработка ошибок и откат транзакций

3. **Оптимизация запросов**:
   - Планируемая оптимизация для повышения производительности
   - Использование индексов и эффективных запросов

## Планы по расширению интеграций

### 1. Улучшение интеграции с Telegram API
- Расширение функциональности для работы с медиа-файлами
- Улучшение обработки больших групп и каналов
- Оптимизация использования API для снижения количества запросов

### 2. Расширение возможностей OpenAI API
- Интеграция с новыми моделями по мере их выпуска
- Добавление функций для анализа тональности сообщений
- Реализация более сложных сценариев анализа диалогов

### 3. Оптимизация работы с базой данных
- Реализация плана оптимизации кеширования
- Добавление полнотекстового поиска
- Улучшение индексов для повышения производительности

## Рекомендации по работе с API

1. **Безопасность**:
   - Хранить API ключи и учетные данные в защищенном виде
   - Не включать чувствительные данные в код

2. **Обработка ошибок**:
   - Реализовать надежную обработку ошибок API
   - Предусмотреть повторные попытки при временных сбоях

3. **Мониторинг**:
   - Отслеживать использование API и связанные расходы
   - Логировать важные события и ошибки

4. **Оптимизация**:
   - Минимизировать количество запросов к внешним API
   - Использовать кеширование для снижения нагрузки