# Архитектура проекта Sammaryhelper

## Общий обзор

Sammaryhelper - это приложение с графическим интерфейсом для автоматизированного анализа и суммаризации диалогов Telegram. Проект использует модульную архитектуру с четким разделением ответственности между компонентами.

## Структура проекта

```
sammaryhelper/
├── Sammaryhelper/              # Основной пакет приложения
│   ├── __init__.py             # Инициализация пакета
│   ├── main.py                 # Точка входа в приложение
│   ├── telegram_client.py      # Основной класс для работы с Telegram API
│   ├── telegram_client_base.py # Базовый класс для работы с Telegram API
│   ├── telegram_client_dialogs.py # Класс для работы с диалогами
│   ├── telegram_client_messages.py # Класс для работы с сообщениями
│   ├── gui.py                  # Графический интерфейс пользователя
│   ├── ai_handler.py           # Обработка данных с использованием AI
│   ├── db_handler.py           # Управление базой данных
│   ├── utils.py                # Вспомогательные функции
│   ├── configs/                # Директория с конфигурационными файлами
│   ├── gui/                    # Дополнительные компоненты GUI
│   ├── gui_components/         # Компоненты GUI
│   └── sessions/               # Директория для хранения сессий Telegram
├── tests/                      # Тесты
│   ├── __init__.py
│   ├── test_init_client.py
│   └── test_main.py
├── utils/                      # Утилиты для разработки
│   └── telegram_viewer.py
├── memory-bank/                # Документация и отслеживание прогресса
├── .venv/                      # Виртуальное окружение Python
├── requirements.txt            # Зависимости проекта
├── pyproject.toml              # Конфигурация проекта
├── setup.py                    # Скрипт установки
└── README.md                   # Описание проекта
```

## Компоненты системы

### 1. Telegram Client

Модуль для взаимодействия с Telegram API, разделенный на несколько классов с использованием наследования:

- **TelegramClientBase** (`telegram_client_base.py`): Базовый класс с основной функциональностью для работы с Telegram API
  - Инициализация клиента
  - Управление подключением
  - Базовое логирование

- **TelegramClientDialogs** (наследуется от TelegramClientBase): Работа с диалогами
  - Получение списка диалогов
  - Фильтрация диалогов
  - Кеширование диалогов

- **TelegramClientMessages** (наследуется от TelegramClientBase): Работа с сообщениями
  - Получение сообщений из чатов
  - Фильтрация сообщений
  - Поиск сообщений
  - Работа с темами в супергруппах

- **TelegramClientManager** (наследуется от TelegramClientDialogs, TelegramClientMessages): Основной класс для работы с Telegram API
  - Объединяет функциональность базового клиента, работы с сообщениями и диалогами

### 2. База данных

Модуль для работы с базой данных PostgreSQL:

- **DatabaseHandler** (`db_handler.py`): Класс для управления базой данных
  - Инициализация подключения к PostgreSQL
  - Создание и обновление таблиц
  - Кеширование диалогов, сообщений и тем
  - Получение кешированных данных

### 3. Графический интерфейс

Модуль для создания и управления графическим интерфейсом пользователя:

- **TelegramSummarizerGUI** (`gui.py`): Основной класс GUI
  - Создание и настройка интерфейса
  - Обработка взаимодействия с пользователем
  - Визуализация данных
  - Асинхронное взаимодействие с Telegram API и базой данных

### 4. AI Handler

Модуль для работы с OpenAI API:

- **AIChatManager** (`ai_handler.py`): Класс для взаимодействия с OpenAI API
  - Получение ответов от модели ИИ
  - Генерация суммаризаций сообщений
  - Анализ участников чата

### 5. Утилиты

Вспомогательные функции и классы:

- **Utils** (`utils.py`): Функции для работы с конфигурацией и настройками
  - Загрузка и сохранение конфигурации
  - Управление настройками приложения

## Взаимодействие компонентов

1. **Инициализация приложения**:
   - `main.py` создает экземпляр `TelegramSummarizerGUI`
   - GUI инициализирует необходимые компоненты (TelegramClientManager, AIChatManager)

2. **Работа с Telegram**:
   - GUI вызывает методы TelegramClientManager для взаимодействия с Telegram API
   - TelegramClientManager использует DatabaseHandler для кеширования данных

3. **Обработка данных**:
   - GUI отображает полученные данные в интерфейсе
   - Пользователь может выбирать диалоги, темы и сообщения
   - Пользователь может выполнять поиск по сообщениям

4. **Взаимодействие с AI**:
   - GUI передает выбранные сообщения в AIChatManager
   - AIChatManager взаимодействует с OpenAI API для получения суммаризаций и ответов

## Асинхронная архитектура

Проект использует асинхронное программирование для обеспечения отзывчивости интерфейса:

1. **Основной поток**: Отвечает за работу GUI и обработку событий пользовательского интерфейса
2. **Asyncio Event Loop**: Выполняет асинхронные операции (запросы к Telegram API, работа с базой данных)
3. **Threading**: Используется для запуска asyncio event loop в отдельном потоке

## Система кеширования

Для оптимизации производительности реализована система кеширования:

1. **Кеширование диалогов**: Сохранение списка диалогов в базе данных
2. **Кеширование сообщений**: Сохранение сообщений из чатов в базе данных
3. **Кеширование тем**: Сохранение тем супергрупп в базе данных
4. **Кеширование AI взаимодействий**: Сохранение запросов и ответов AI

## Схема базы данных

База данных PostgreSQL содержит следующие таблицы:

1. **dialogs**: Хранение информации о диалогах
   - id (BIGINT): ID диалога
   - name (TEXT): Название диалога
   - type (TEXT): Тип диалога
   - folder_id (INTEGER): ID папки
   - account_id (TEXT): ID аккаунта
   - data (JSONB): Полные данные о диалоге

2. **messages**: Хранение сообщений
   - id (BIGINT): ID сообщения
   - dialog_id (BIGINT): ID диалога
   - sender_id (BIGINT): ID отправителя
   - sender_name (TEXT): Имя отправителя
   - text (TEXT): Текст сообщения
   - date (TIMESTAMP): Дата сообщения
   - account_id (TEXT): ID аккаунта
   - message_thread_id (BIGINT): ID темы (для супергрупп)
   - data (JSONB): Полные данные о сообщении

3. **topics**: Хранение тем супергрупп
   - id (BIGINT): ID темы
   - dialog_id (BIGINT): ID диалога
   - title (TEXT): Название темы
   - account_id (TEXT): ID аккаунта
   - data (JSONB): Полные данные о теме

4. **ai_requests** и **ai_responses**: Хранение взаимодействий с AI
   - Запросы к AI и полученные ответы

## Планы по улучшению архитектуры

1. **Оптимизация кеширования**: Реализация плана оптимизации кеширования для поиска по нескольким чатам
2. **Улучшение модульности**: Дальнейшее разделение компонентов для улучшения тестируемости
3. **Расширение функциональности AI**: Добавление новых возможностей для анализа сообщений
4. **Улучшение пользовательского интерфейса**: Оптимизация визуализации результатов поиска